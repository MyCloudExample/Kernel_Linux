# Esqueleto de Char Device con compilaci√≥n en directorio build
FILE := char_device_3
AUTHOR := TD3
KDIR := /lib/modules/$(shell uname -r)/build
MDIR := $(PWD)/build

# Codigo fuente para compilar
obj-m += ${FILE}.o

# Compilacion completa en directorio build
all:
	@echo "üî® Compilando esqueleto de char device..."
	@mkdir -p build;					\
	cp -f ${FILE}.c Makefile ${MDIR};	\
	cd build;									\
	make -C ${KDIR} M=${MDIR} modules
	@echo "‚úÖ Compilaci√≥n completada en directorio build/"

# Limpia el directorio de compilacion
clean:
	@echo "üßπ Limpiando directorio build..."
	@if [ -d "build" ]; then \
		cd build; \
		make -C ${KDIR} M=${MDIR} clean; \
		cd ..; \
		rm -rf build; \
	fi
	@echo "‚úÖ Limpieza completada"

# Carga el modulo en el kernel
load:
	@echo "‚¨ÜÔ∏è Cargando m√≥dulo..."
	@sudo insmod build/${FILE}.ko

# Quita el modulo del kernel
unload:
	@echo "‚¨áÔ∏è Descargando m√≥dulo..."
	@sudo rmmod ${FILE}

# Muestra informaci√≥n del dispositivo
info:
	@echo "üìä Informaci√≥n del sistema:"
	@echo "=== ARCHIVO DISPOSITIVO ==="
	@ls -la /dev/td3_dispositivo 2>/dev/null || echo "El dispositivo no existe"
	@echo "=== M√ìDULOS CARGADOS ==="
	@lsmod | grep td3 || echo "No hay m√≥dulos TD3 cargados"
	@echo "=== MENSAJES KERNEL ==="
	@dmesg | grep "TD3" | tail -5 || echo "No hay mensajes recientes"

# Prueba r√°pida del dispositivo
test:
	@echo "üß™ Probando dispositivo..."
	@echo "=== VERIFICANDO EXISTENCIA ==="
	@if [ -c "/dev/td3_dispositivo" ]; then \
		echo "‚úÖ Archivo dispositivo EXISTE"; \
	else \
		echo "‚ùå Archivo dispositivo NO existe"; \
	fi
	@echo "=== INTENTO ESCRITURA ==="
	@echo "test" | sudo tee /dev/td3_dispositivo 2>&1 | grep -v "test" || true
	@echo "=== INTENTO LECTURA ==="
	@sudo cat /dev/td3_dispositivo 2>&1 | head -1 || true
	@echo "=== VERIFICANDO MENSAJES KERNEL ==="
	@dmesg | grep "TD3" | tail -3

# Limpia y recarga el m√≥dulo
reload: clean all load info

# Muestra ayuda
help:
	@echo "=== MAKE TARGETS PARA ESQUELETO CHAR DEVICE ==="
	@echo "all     : Compila el m√≥dulo en directorio build/ (por defecto)"
	@echo "clean   : Limpia el directorio build/"
	@echo "load    : Carga el m√≥dulo en el kernel"
	@echo "unload  : Descarga el m√≥dulo del kernel"
	@echo "info    : Muestra informaci√≥n del sistema"
	@echo "test    : Prueba b√°sica del dispositivo"
	@echo "reload  : Limpia, recompila y recarga el m√≥dulo"
	@echo "help    : Muestra esta ayuda"