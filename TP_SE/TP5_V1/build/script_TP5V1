#!/bin/bash

# Colores para output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}üîÑ EJECUCI√ìN DEL M√ìDULO POR 5 SEGUNDOS${NC}"
echo "=========================================="

# Funci√≥n para verificar si el m√≥dulo est√° cargado
verificar_modulo() {
    if lsmod | grep -q "kernel_module"; then
        echo -e "${GREEN}‚úÖ M√≥dulo cargado correctamente${NC}"
        return 0
    else
        echo -e "${RED}‚ùå Error: M√≥dulo NO est√° cargado${NC}"
        return 1
    fi
}

# Paso 1: Compilar
echo -e "${YELLOW}1. Compilando m√≥dulo...${NC}"
make clean
make all

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå Error en la compilaci√≥n${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ Compilaci√≥n exitosa${NC}"
echo ""

# Paso 2: Limpiar buffer del kernel
echo -e "${YELLOW}2. Limpiando buffer del kernel...${NC}"
sudo dmesg -C
echo -e "${GREEN}‚úÖ Buffer limpiado${NC}"
echo ""

# Paso 3: Cargar m√≥dulo
echo -e "${YELLOW}3. Cargando m√≥dulo (los hilos empezar√°n a ejecutarse)...${NC}"
make insmod

# Verificar directamente con nuestra funci√≥n
if verificar_modulo; then
    echo ""
else
    echo -e "${RED}‚ùå Error al cargar el m√≥dulo${NC}"
    exit 1
fi

# Paso 4: Esperar 5 segundos mostrando cuenta regresiva
echo -e "${YELLOW}4. Ejecutando por 5 segundos...${NC}"
for i in {5..1}; do
    echo "‚è∞ Tiempo restante: ${i} segundos"
    sleep 1
done
echo -e "${GREEN}‚úÖ Tiempo de ejecuci√≥n completado${NC}"
echo ""

# Paso 5: Mostrar mensajes generados durante la ejecuci√≥n
echo -e "${YELLOW}5. Mensajes generados durante la ejecuci√≥n:${NC}"
echo "----------------------------------------"
make dmesg
echo "----------------------------------------"
echo ""

# Paso 6: Descargar m√≥dulo
echo -e "${YELLOW}6. Descargando m√≥dulo...${NC}"
make rmmod

# Verificar que se descarg√≥
if lsmod | grep -q "kernel_module"; then
    echo -e "${RED}‚ùå Error: M√≥dulo sigue cargado${NC}"
else
    echo -e "${GREEN}‚úÖ M√≥dulo descargado${NC}"
fi
echo ""

# Paso 7: Mostrar mensajes finales
echo -e "${YELLOW}7. Mensajes finales:${NC}"
echo "----------------------------------------"
make dmesg
echo "----------------------------------------"
echo ""

echo -e "${BLUE}üéØ EJECUCI√ìN COMPLETADA EXITOSAMENTE${NC}"
echo -e "${GREEN}Los hilos ejecutaron durante exactamente 5 segundos${NC}"
